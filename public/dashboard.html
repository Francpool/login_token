<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <style>
      #userInfo, #flatInfo {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    .user-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background-color: #f9f9f9;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
      position: relative;
    }
    .user-card h3 { margin: 0; font-size: 1.2rem; }
    .user-card p { margin: 4px 0; font-size: 0.9rem; color: #555; }
    .user-card button {
      margin: 8px 5px 0 0;
      padding: 6px 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .edit-btn { background-color: #007bff; color: #fff; }
    .edit-btn:hover { background-color: #0056b3; }
    .delete-btn { background-color: #dc3545; color: #fff; }
    .delete-btn:hover { background-color: #c82333; }

    #logoutButton {
      background-color: #dc3545;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      margin: 20px 0;
      display: block;
      max-width: 150px;
      margin-left: auto;
      margin-right: auto;
    }
    #logoutButton:hover { background-color: #c82333; }

    /* Modal Styles */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 999;
      left: 0; top: 0; width: 100vw; height: 100vh;
      overflow: auto; background: rgba(0,0,0,0.3);
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; border-radius: 8px; padding: 20px; min-width: 300px;
      max-width: 95vw; position: relative;
    }
    .close-modal {
      position: absolute; top: 8px; right: 16px; font-size: 1.2rem; cursor: pointer; color: #333;
    }
    .modal label { display: block; margin: 10px 0 2px; }
    .modal input { width: 100%; padding: 5px; margin-bottom: 10px; }
    .modal button { margin-top: 10px; }
  </style>
</head>
<body>
  <h1 id="welcomeMessage">Welcome, User</h1>
  <div id="userInfo"></div>
   <h2>Your Flats</h2>
  <div id="flatInfo"></div>

  <button id="logoutButton">Logout</button>

  <!-- Modal for Edit -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <span class="close-modal" id="closeEditModal">&times;</span>
      <h2>Edit User</h2>
      <form id="editUserForm">
        <input type="hidden" id="editUserId">
        <label>Email: <input type="email" id="editEmail" required></label>
        <label>First Name: <input type="text" id="editFirstname" required></label>
        <label>Last Name: <input type="text" id="editLastname" required></label>
        <label>Birth Date: <input type="date" id="editBirthdate" required></label>
        <label>Is Admin: 
          <select id="editIsAdmin">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </label>
        <button type="submit" class="edit-btn">Save</button>
      </form>
    </div>
  </div>
  <!-- Modal for Delete -->
  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <span class="close-modal" id="closeDeleteModal">&times;</span>
      <h2>Delete User</h2>
      <p>Are you sure you want to delete this user?</p>
      <button id="confirmDeleteBtn" class="delete-btn">Yes, Delete</button>
      <button id="cancelDeleteBtn" class="edit-btn">Cancel</button>
    </div>
  </div>
   <!-- Modal Editar Flat -->
  <div class="modal" id="editFlatModal">
    <div class="modal-content">
      <span class="close-modal" id="closeEditFlatModal">&times;</span>
      <h2>Edit Flat</h2>
      <form id="editFlatForm">
        <input type="hidden" name="id" id="editFlatId">
        <label>City: <input type="text" name="city" id="editCity" required></label>
        <label>Street Name: <input type="text" name="streetName" id="editStreetName" required></label>
        <label>Street Number: <input type="text" name="streetNumber" id="editStreetNumber" required></label>
        <label>Area Size (mÂ²): <input type="number" name="areaSize" id="editAreaSize" required></label>
        <label>Has AC: 
          <select name="hasAC" id="editHasAC">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
        </label>
        <label>Year Built: <input type="number" name="yearBuilt" id="editYearBuilt" required></label>
        <label>Rent Price: <input type="number" name="rentPrice" id="editRentPrice" required></label>
        <label>Date Available: <input type="date" name="dateAvailable" id="editDateAvailable" required></label>
        <button type="submit" class="edit-btn">Save</button>
      </form>
    </div>
  </div>
  <!-- Modal Delete Flat -->
  <div class="modal" id="deleteFlatModal">
    <div class="modal-content">
      <span class="close-modal" id="closeDeleteFlatModal">&times;</span>
      <h2>Delete Flat</h2>
      <p>Are you sure you want to delete this flat?</p>
      <button id="confirmDeleteFlatBtn" class="delete-btn">Yes, Delete</button>
      <button id="cancelDeleteFlatBtn" class="edit-btn">Cancel</button>
    </div>
  </div>

  <script>
    let flatsCache = [];
    let user = null;
    let deleteFlatId = null;

document.addEventListener("DOMContentLoaded", async () => {
  const token = localStorage.getItem("token");
  const firstname = localStorage.getItem("firstname");
  const email = localStorage.getItem("email");

  if (!token || !firstname || !email) {
    alert("User not logged in");
    window.location.href = "/index.html";
    return;
  }

  document.getElementById("welcomeMessage").textContent = `Welcome, ${firstname} (${email})`;

 // ObtÃ©n info usuario
const userId = localStorage.getItem("userId");  // <--- ObtÃ©n el ID guardado tras login
const resUser = await fetch(`/users/${userId}`, {
  headers: { Authorization: `Bearer ${token}` }
});
user = await resUser.json();
console.log("Usuario obtenido del backend:", user);


  // Muestra info usuario actual (puedes dejarlo o quitarlo si vas a mostrar todos los usuarios abajo)
  displayUserCard(user);

  // Si es admin, cargar todos los usuarios
  if (user.isAdmin) {
    await loadAllUsers(token);  // <--- AquÃ­ llamas a la funciÃ³n
  }

  // Carga flats (tuyos si no admin, todos si admin)
  loadFlats(token, user);
});

async function loadAllUsers(token) {
  const resAll = await fetch("/users", {
    headers: { Authorization: `Bearer ${token}` }
  });
  const users = await resAll.json();
  displayAllUsers(users);
}

function displayAllUsers(users) {
  const container = document.getElementById("userInfo");
  let html = '';
  users.forEach(u => {
    html += `
      <div class="user-card">
        <h3>${u.firstname} ${u.lastname}</h3>
        <p><strong>ID:</strong> ${u._id}</p>
        <p><strong>Email:</strong> ${u.email || "Not provided"}</p>
        <p><strong>First Name:</strong> ${u.firstname}</p>
        <p><strong>Last Name:</strong> ${u.lastname}</p>
        <p><strong>Birth Date:</strong> ${u.birthdate ? new Date(u.birthdate).toLocaleDateString() : "Not provided"}</p>
        <p><strong>Is Admin:</strong> ${u.isAdmin ? "Yes" : "No"}</p>
        <button class="edit-btn" onclick="openEditModal('${u._id}')">Edit</button>
        <button class="delete-btn" onclick="openDeleteModal('${u._id}')">Delete</button>
      </div>
    `;
  });
  container.innerHTML = html;
}

// ---- USUARIOS: EDITAR Y ELIMINAR (ADMIN) ----
let usersCache = [];
let deleteUserId = null;

// Sobrescribe displayAllUsers para guardar en usersCache
function displayAllUsers(users) {
  usersCache = users; // ðŸ‘ˆ Necesario para modales
  const container = document.getElementById("userInfo");
  let html = '';
  users.forEach(u => {
    html += `
      <div class="user-card">
        <h3>${u.firstname} ${u.lastname}</h3>
        <p><strong>ID:</strong> ${u._id}</p>
        <p><strong>Email:</strong> ${u.email || "Not provided"}</p>
        <p><strong>First Name:</strong> ${u.firstname}</p>
        <p><strong>Last Name:</strong> ${u.lastname}</p>
        <p><strong>Birth Date:</strong> ${u.birthdate ? new Date(u.birthdate).toLocaleDateString() : "Not provided"}</p>
        <p><strong>Is Admin:</strong> ${u.isAdmin ? "Yes" : "No"}</p>
        <button class="edit-btn" onclick="openEditModal('${u._id}')">Edit</button>
        <button class="delete-btn" onclick="openDeleteModal('${u._id}')">Delete</button>
      </div>
    `;
  });
  container.innerHTML = html;
}

// Abre modal de editar usuario
window.openEditModal = function(userId) {
  const user = usersCache.find(u => u._id === userId);
  if (!user) return;
  document.getElementById('editUserId').value = user._id;
  document.getElementById('editEmail').value = user.email;
  document.getElementById('editFirstname').value = user.firstname;
  document.getElementById('editLastname').value = user.lastname;
  document.getElementById('editBirthdate').value = user.birthdate ? new Date(user.birthdate).toISOString().split('T')[0] : '';
  document.getElementById('editIsAdmin').value = user.isAdmin ? "true" : "false";
  document.getElementById('editModal').style.display = 'flex';
};
document.getElementById('closeEditModal').onclick = () => document.getElementById('editModal').style.display = 'none';

document.getElementById('editUserForm').onsubmit = async function(e) {
  e.preventDefault();
  const token = localStorage.getItem("token");
  const userId = document.getElementById('editUserId').value;
  const data = {
    email: document.getElementById('editEmail').value,
    firstname: document.getElementById('editFirstname').value,
    lastname: document.getElementById('editLastname').value,
    birthdate: document.getElementById('editBirthdate').value,
    isAdmin: document.getElementById('editIsAdmin').value === "true"
  };
  const res = await fetch(`/users/${userId}`, {
    method: 'PUT',
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify(data)
  });
  if (res.ok) {
    document.getElementById('editModal').style.display = 'none';
    await loadAllUsers(token); // recarga usuarios
    alert("User updated successfully");
  } else {
    alert("Failed to update user");
  }
};

// Abre modal de borrar usuario
window.openDeleteModal = function(userId) {
  deleteUserId = userId;
  document.getElementById('deleteModal').style.display = 'flex';
};
document.getElementById('closeDeleteModal').onclick = () => document.getElementById('deleteModal').style.display = 'none';
document.getElementById('cancelDeleteBtn').onclick = () => document.getElementById('deleteModal').style.display = 'none';
document.getElementById('confirmDeleteBtn').onclick = async function() {
  const token = localStorage.getItem("token");
  const res = await fetch(`/users/${deleteUserId}`, {
    method: 'DELETE',
    headers: { Authorization: `Bearer ${token}` }
  });
  if (res.ok) {
    document.getElementById('deleteModal').style.display = 'none';
    await loadAllUsers(token); // recarga usuarios
    alert("User deleted successfully");
  } else {
    alert("Failed to delete user");
  }
};



    function displayUserCard(user) {
      const userInfo = `
        <div class="user-card">
          <h3>Your Information</h3>
          <p><strong>ID:</strong> ${user._id || user.id}</p>
          <p><strong>Email:</strong> ${user.email || ""}</p>
          <p><strong>First Name:</strong> ${user.firstname}</p>
          <p><strong>Last Name:</strong> ${user.lastname}</p>
          <p><strong>Birth Date:</strong> ${user.birthdate ? new Date(user.birthdate).toLocaleDateString() : "Not provided"}</p>
          <p><strong>Is Admin:</strong> ${user.isAdmin ? "Yes" : "No"}</p>
        </div>
      `;
      document.getElementById("userInfo").innerHTML = userInfo;
    }

    // Flats
    async function loadFlats(token, user) {
      const res = await fetch("/flats");
      flatsCache = await res.json();

      // Si no eres admin, solo tus flats
      let flatsToShow = flatsCache;
      if (!user.isAdmin) {
        flatsToShow = flatsCache.filter(flat =>
          (flat.owner?._id || flat.owner) == (user._id || user.id)
        );
      }
      displayFlats(flatsToShow, user);
    }

    function displayFlats(flats, user) {
      const container = document.getElementById("flatInfo");
      let html = "";
      flats.forEach(flat => {
        html += `
          <div class="user-card">
            <h3>${flat.city}, ${flat.streetName} ${flat.streetNumber}</h3>
            <p><strong>ID:</strong> ${flat._id}</p>
            <p><strong>Area:</strong> ${flat.areaSize} mÂ²</p>
            <p><strong>AC:</strong> ${flat.hasAC ? "Yes" : "No"}</p>
            <p><strong>Year Built:</strong> ${flat.yearBuilt}</p>
            <p><strong>Rent Price:</strong> $${flat.rentPrice}</p>
            <p><strong>Date Available:</strong> ${flat.dateAvailable ? new Date(flat.dateAvailable).toLocaleDateString() : "N/A"}</p>
            <p><strong>Owner:</strong> ${flat.owner?.firstname || ""} ${flat.owner?.lastname || ""} (${flat.owner?.email || flat.owner})</p>
            <p><strong>Created:</strong> ${new Date(flat.createdAt).toLocaleString()}</p>
            <p><strong>Updated:</strong> ${new Date(flat.updatedAt).toLocaleString()}</p>
            ${(flat.owner && (flat.owner._id || flat.owner) == (user._id || user.id)) ? `
              <button class="edit-btn" onclick="openEditFlatModal('${flat._id}')">Edit</button>
              <button class="delete-btn" onclick="openDeleteFlatModal('${flat._id}')">Delete</button>
            ` : ""}
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // Editar Flat - Modal
    window.openEditFlatModal = function(flatId) {
      const flat = flatsCache.find(f => f._id === flatId);
      if (!flat) return;
      document.getElementById("editFlatId").value = flat._id;
      document.getElementById("editCity").value = flat.city;
      document.getElementById("editStreetName").value = flat.streetName;
      document.getElementById("editStreetNumber").value = flat.streetNumber;
      document.getElementById("editAreaSize").value = flat.areaSize;
      document.getElementById("editHasAC").value = flat.hasAC ? "true" : "false";
      document.getElementById("editYearBuilt").value = flat.yearBuilt;
      document.getElementById("editRentPrice").value = flat.rentPrice;
      document.getElementById("editDateAvailable").value = flat.dateAvailable ? flat.dateAvailable.split("T")[0] : "";
      document.getElementById("editFlatModal").style.display = "flex";
    };
    document.getElementById("closeEditFlatModal").onclick = () => document.getElementById("editFlatModal").style.display = "none";

    document.getElementById("editFlatForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const id = document.getElementById("editFlatId").value;
      const data = {
        city: document.getElementById("editCity").value,
        streetName: document.getElementById("editStreetName").value,
        streetNumber: document.getElementById("editStreetNumber").value,
        areaSize: Number(document.getElementById("editAreaSize").value),
        hasAC: document.getElementById("editHasAC").value === "true",
        yearBuilt: Number(document.getElementById("editYearBuilt").value),
        rentPrice: Number(document.getElementById("editRentPrice").value),
        dateAvailable: document.getElementById("editDateAvailable").value
      };
      const token = localStorage.getItem("token");
      const res = await fetch(`/flats/${id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        alert("Flat updated!");
        document.getElementById("editFlatModal").style.display = "none";
        loadFlats(token, user);
      } else {
        const result = await res.json();
        alert(result.error || "Failed to update flat");
      }
    });

    // Borrar Flat - Modal
    window.openDeleteFlatModal = function(flatId) {
      deleteFlatId = flatId;
      document.getElementById('deleteFlatModal').style.display = 'flex';
    };
    document.getElementById('closeDeleteFlatModal').onclick = () => document.getElementById('deleteFlatModal').style.display = 'none';
    document.getElementById('cancelDeleteFlatBtn').onclick = () => document.getElementById('deleteFlatModal').style.display = 'none';
    document.getElementById('confirmDeleteFlatBtn').onclick = async function() {
      const token = localStorage.getItem("token");
      const res = await fetch(`/flats/${deleteFlatId}`, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}` }
      });
      if (res.ok) {
        alert("Flat deleted!");
        document.getElementById('deleteFlatModal').style.display = 'none';
        loadFlats(token, user);
      } else {
        const result = await res.json();
        alert(result.error || "Failed to delete flat");
      }
    };

    // Logout
    document.getElementById("logoutButton").addEventListener("click", () => {
      localStorage.removeItem("token");
      localStorage.removeItem("firstname");
      localStorage.removeItem("email");
      alert("Logged out successfully");
      window.location.href = "/index.html";
    });
  </script>
</body>
</html>